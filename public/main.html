<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Journal - –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --border: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-left h1 {
            font-size: 26px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.15);
            padding: 12px 18px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .user-role {
            background: var(--success);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--light);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
        }

        .tab {
            padding: 18px 30px;
            background: transparent;
            color: var(--gray);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .tab:hover {
            color: var(--primary);
            background: rgba(255,255,255,0.5);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Calendar */
        .calendar-section {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .current-date {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .calendar-nav {
            display: flex;
            gap: 12px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: 700;
            color: var(--dark);
            font-size: 13px;
            background: var(--light);
        }

        .calendar-day {
            padding: 15px 10px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 15px;
            position: relative;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: #e3f2fd;
            transform: scale(1.05);
            z-index: 1;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
            z-index: 1;
        }

        .calendar-day.today {
            background: #fff3cd;
            font-weight: 700;
            border: 2px solid var(--warning);
        }

        .calendar-day.weekend {
            background: #f8f9fa;
            color: var(--danger);
        }

        .calendar-day.has-data::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
        }

        .calendar-day.absent-data::after {
            background: var(--danger);
        }

        .calendar-day.readonly {
            background: #f8f9fa;
            color: var(--gray);
            cursor: not-allowed;
        }

        .calendar-day.readonly:hover {
            background: #f8f9fa;
            transform: none;
            box-shadow: none;
        }

        .day-number {
            font-size: 18px;
            font-weight: 700;
        }

        .day-stats {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.8;
            font-weight: 600;
        }

        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            margin-bottom: 25px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 15px;
        }

        .filter-select {
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
            outline: none;
        }

        /* Students Grid */
        .students-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ */
        .student-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
            
        }

        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .student-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .student-details {
            color: var(--gray);
            font-size: 13px;
        }

        .attendance-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-present {
            background: rgba(39, 174, 96, 0.15);
            color: var(--success);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .status-absent {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .status-unknown {
            background: rgba(127, 140, 141, 0.15);
            color: var(--gray);
            border: 1px solid rgba(127, 140, 141, 0.3);
        }

        /* –ü–æ—á–∞—Å–æ–≤–æ–π —É—á–µ—Ç */
        .hourly-controls {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .hour-label {
            font-size: 11px;
            text-align: center;
            margin-bottom: 8px;
            color: var(--gray);
            font-weight: 700;
        }
        
        .hour-btn {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            min-height: 32px;
            font-weight: 600;
        }
        
        .hour-btn.present {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .hour-btn.absent {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .hour-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hour-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        
        .hour-summary {
            font-size: 12px;
            margin-top: 12px;
            text-align: center;
            color: var(--dark);
            font-weight: 700;
        }
        
        .hourly-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .hours-present {
            color: var(--success);
        }
        
        .hours-absent {
            color: var(--danger);
        }

        /* Weekly Report */
        .week-report {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .week-report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .week-nav {
            display: flex;
            gap: 12px;
        }

        .current-week {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .report-table th {
            background: var(--light);
            padding: 10px 6px;
            text-align: center;
            font-weight: 700;
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .report-table td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .student-name-cell {
            text-align: left;
            font-weight: 700;
            background: var(--light);
            padding: 12px 15px;
            min-width: 180px;
            position: sticky;
            left: 0;
        }

        .present-cell {
            background: #d4edda;
            color: #155724;
        }

        .absent-cell {
            background: #f8d7da;
            color: #721c24;
        }

        .total-cell {
            background: var(--primary);
            color: white;
            font-weight: 700;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.4s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: rgba(39, 174, 96, 0.95);
        }

        .notification.error {
            background: rgba(231, 76, 60, 0.95);
        }

        .notification.warning {
            background: rgba(243, 156, 18, 0.95);
        }

        /* Save Button */
        .save-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Online Status */
        .online-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            font-size: 13px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-indicator.offline {
            background: var(--danger);
            animation: none;
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
            transform: translateY(-30px) scale(0.95);
            transition: all 0.4s ease;
        }
        
        .modal-overlay.show .modal {
            transform: translateY(0) scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
            outline: none;
        }
        
        textarea.form-control {
            min-height: 140px;
            resize: vertical;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        /* Add Student Button */
        .add-student-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            text-align: center;
        }
        
        .add-student-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .add-student-btn:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Group Selector */
        .group-selector {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .group-filters {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: end;
        }

        /* Students Grid Layout */
        .students-grid-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        /* Batch Add Students */
        .batch-add-section {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .batch-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .students-preview {
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
            margin-bottom: 20px;
        }

        .student-preview-item {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        .student-preview-item:last-child {
            border-bottom: none;
        }

        /* Edit Mode Indicator */
        .edit-mode-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: var(--warning);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 15px;
            animation: pulse 2s infinite;
        }

        /* Blacklist */
        .blacklist-section {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .blacklist-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .blacklist-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .blacklist-card.danger {
            border-left: 5px solid var(--danger);
        }

        .blacklist-card.warning {
            border-left: 5px solid var(--warning);
        }

        .blacklist-card.info {
            border-left: 5px solid var(--primary);
        }

        .blacklist-student {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 5px solid var(--danger);
        }

        .blacklist-student.warning {
            border-left-color: var(--warning);
        }

        /* Reason cells */
        .reason-cell {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reason-cell:hover {
            background: #f8f9fa;
        }

        .reason-valid {
            background: rgba(39, 174, 96, 0.1);
            color: #155724;
        }

        .reason-invalid {
            background: rgba(231, 76, 60, 0.1);
            color: #721c24;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .group-filters {
                grid-template-columns: 1fr;
            }
            
            .batch-controls {
                grid-template-columns: 1fr;
            }
            
            .students-grid-cards {
                grid-template-columns: 1fr;
            }
            
            .hourly-controls {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .report-table {
                font-size: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
                text-align: center;
            }
            
            .blacklist-stats {
                grid-template-columns: 1fr;
            }
        }

        /* –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Å—Ç–∏–ª—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ CSS –ø—Ä–∞–≤–∏–ª–∞ */
.report-table td:not(.student-name-cell) {
    border-right: 1px solid var(--border);
}

.report-table td.last-hour-of-day {
    border-right: 2px solid var(--dark) !important;
}

.report-table th:not(:first-child) {
    border-right: 1px solid var(--border);
}

.report-table th.day-separator {
    border-right: 2px solid var(--dark) !important;
}

/* Quick Actions */
.quick-actions {
    margin-top: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.quick-actions-title {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dark);
    text-align: center;
}

.quick-actions-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.btn-mark-all-present, .btn-mark-all-absent {
    flex: 1;
    padding: 8px 12px;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
}

.btn-mark-all-present {
    background: var(--success);
}

.btn-mark-all-absent {
    background: var(--danger);
}

.btn-mark-all-present:disabled, .btn-mark-all-absent:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ */
.absence-reason-controls {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    justify-content: center;
}

.absence-reason-btn {
    flex: 1;
    padding: 10px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.absence-reason-btn.valid {
    background: var(--success);
    color: white;
}

.absence-reason-btn.invalid {
    background: var(--danger);
    color: white;
}

.absence-reason-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.absence-reason-btn:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

.absence-reason-indicator {
    font-size: 11px;
    margin-top: 8px;
    text-align: center;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
}

.absence-reason-indicator.valid {
    background: rgba(39, 174, 96, 0.15);
    color: var(--success);
}

.absence-reason-indicator.invalid {
    background: rgba(231, 76, 60, 0.15);
    color: var(--danger);
}

.absence-reason-indicator.none {
    background: rgba(127, 140, 141, 0.15);
    color: var(--gray);
}

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>üìí Smart Journal</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
                <div class="online-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
                </div>
            </div>
            <div class="user-info">
                <span id="userName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã</span>
                <span class="user-role" id="userRole">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                <button class="btn btn-logout" id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-page="daily">üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —É—á–µ—Ç</button>
            <button class="tab" data-page="weekly">üìä –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç</button>
            <button class="tab" data-page="students">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</button>
            <button class="tab" data-page="absence">üìù –ü—Ä–æ–ø—É—Å–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤</button>
            <button class="tab" data-page="blacklist">‚ö†Ô∏è –ù–ë —É—á–µ–Ω–∏–∫–æ–≤</button>
        </div>

        <!-- Daily Attendance Page -->
        <div id="dailyPage" class="tab-content active">
            <div class="calendar-section">
                <div class="calendar-header">
                    <div class="current-date" id="currentDate"></div>
                    <div class="calendar-nav">
                        <button class="btn" id="prevMonth">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
                        <button class="btn btn-primary" id="todayBtn">–°–µ–≥–æ–¥–Ω—è</button>
                        <button class="btn" id="nextMonth">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <div class="group-selector">
                <div class="group-filters">
                    <div class="filter-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é:</label>
                        <select class="filter-select" id="professionSelect">
                            <option value="">–í—Å–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary" id="applyFilterBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>–î–∞—Ç–∞: <span id="selectedDateDisplay"></span></label>
                </div>
                <div id="editModeContainer">
                    <button class="btn btn-warning" id="editModeBtn">
                        ‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    </button>
                    <span id="editModeIndicator" class="edit-mode-indicator" style="display: none;">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="dailyTotalStudents">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dailyPresent">0</div>
                    <div class="stat-label">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dailyAbsent">0</div>
                    <div class="stat-label">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dailyAttendance">0%</div>
                    <div class="stat-label">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div>
                </div>
            </div>

            <div class="save-section" id="saveSection">
                <button class="btn btn-success" id="saveAttendanceBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
            </div>

            <div class="students-container">
                <div class="students-grid-cards" id="studentsGrid"></div>
            </div>
        </div>

        <!-- Weekly Report Page -->
        <div id="weeklyPage" class="tab-content">
            <div class="week-report-header">
                <div class="current-week" id="currentWeekRange"></div>
                <div class="week-nav">
                    <button class="btn" id="prevWeek">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                    <button class="btn" id="nextWeek">–°–ª–µ–¥—É—é—â–∞—è ‚ñ∂</button>
                </div>
            </div>

            <div class="group-selector">
                <div class="group-filters">
                    <div class="filter-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é:</label>
                        <select class="filter-select" id="weeklyProfessionSelect">
                            <option value="">–í—Å–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary" id="weeklyApplyFilterBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="weeklyTotalStudents">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weeklyAvgAttendance">0%</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω—è—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weeklyTotalPresent">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weeklyTotalAbsent">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ</div>
                </div>
            </div>

            <div class="week-report">
                <div id="weeklyTableContainer" style="overflow-x: auto;">
                    <table class="report-table" id="weeklyTable">
                        <thead id="weeklyTableHead"></thead>
                        <tbody id="weeklyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Students Management Page -->
        <div id="studentsPage" class="tab-content">
            <div class="batch-add-section">
                <h3>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥—Ä—É–ø–ø–∞–º–∏</h3>
                <div class="batch-controls">
                    <div class="filter-group">
                        <label>–ü—Ä–æ—Ñ–µ—Å—Å–∏—è:</label>
                        <select class="filter-select" id="batchProfessionSelect" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-success" id="addMultipleStudentsBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</button>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</h3>
                </div>
                <div>
                    <button class="btn btn-success" id="addStudentBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</button>
                </div>
            </div>

            <div class="students-container">
                <div class="students-grid-cards" id="studentsTableBody"></div>
            </div>
        </div>

        <!-- Absence Reasons Page -->
        <div id="absencePage" class="tab-content">
            <div class="group-selector">
                <div class="group-filters">
                    <div class="filter-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é:</label>
                        <select class="filter-select" id="absenceProfessionSelect">
                            <option value="">–í—Å–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary" id="absenceApplyFilterBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω–∞–º–∏ –ø—Ä–æ–ø—É—Å–∫–æ–≤</h3>
                    <p style="color: var(--gray); font-size: 14px; margin-top: 5px;">
                        –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–æ–≤
                    </p>
                </div>
            </div>

            <div class="week-report">
                <div id="absenceTableContainer" style="overflow-x: auto;">
                    <table class="report-table" id="absenceTable">
                        <thead id="absenceTableHead"></thead>
                        <tbody id="absenceTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="absencePage" class="tab-content">
    <!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º -->
    <div class="week-report-header">
        <div class="current-week" id="absenceCurrentWeekRange"></div>
        <div class="week-nav">
            <button class="btn" id="absencePrevWeek">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <button class="btn" id="absenceNextWeek">–°–ª–µ–¥—É—é—â–∞—è ‚ñ∂</button>
        </div>
    </div>

        <!-- Blacklist Page -->
        <div id="blacklistPage" class="tab-content">
            <div class="group-selector">
                <div class="group-filters">
                    <div class="filter-group">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é:</label>
                        <select class="filter-select" id="blacklistProfessionSelect">
                            <option value="">–í—Å–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary" id="blacklistApplyFilterBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                    </div>
                </div>
            </div>

            <div class="blacklist-stats">
                <div class="blacklist-card danger">
                    <div class="stat-value" id="blacklistCount">0</div>
                    <div class="stat-label">–í —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ</div>
                </div>
                <div class="blacklist-card warning">
                    <div class="stat-value" id="warningCount">0</div>
                    <div class="stat-label">–ù–∞ –≥—Ä–∞–Ω–∏ –ø–æ–ø–∞–¥–∞–Ω–∏—è</div>
                </div>
                <div class="blacklist-card info">
                    <div class="stat-value" id="totalAbsenceHours">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —á–∞—Å–æ–≤ –ø—Ä–æ–ø—É—Å–∫–æ–≤</div>
                </div>
            </div>

            <div class="blacklist-section">
                <h3 style="margin-bottom: 20px;">–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
                <div id="blacklistStudents"></div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
                <button class="modal-close" id="closeAddStudentModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="studentName">–§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞:</label>
                    <input type="text" id="studentName" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label for="studentProfession">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è:</label>
                    <select id="studentProfession" class="form-control" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelAddStudent">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" id="confirmAddStudent">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</button>
            </div>
        </div>
    </div>

    <!-- Add Multiple Students Modal -->
    <div id="addMultipleStudentsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
                <button class="modal-close" id="closeMultipleStudentsModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="multipleStudentsNames">–°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É, –º–∞–∫—Å–∏–º—É–º 33):</label>
                    <textarea id="multipleStudentsNames" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –∫–∞–∂–¥–æ–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: <span id="selectedProfessionName"></span></label>
                    <input type="hidden" id="multipleStudentsProfession">
                </div>
                <div class="students-preview" id="multipleStudentsPreview"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelMultipleStudents">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" id="confirmMultipleStudents">–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</button>
            </div>
        </div>
    </div>

    <!-- Edit Reason Modal -->
    <div id="editReasonModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∞</h3>
                <button class="modal-close" id="closeEditReasonModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="reasonStudentName">–°—Ç—É–¥–µ–Ω—Ç:</label>
                    <input type="text" id="reasonStudentName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="reasonDate">–î–∞—Ç–∞:</label>
                    <input type="text" id="reasonDate" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="reasonHour">–ß–∞—Å:</label>
                    <input type="text" id="reasonHour" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–ø—É—Å–∫–∞:</label>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-success" id="setValidReason">–£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è</button>
                        <button class="btn btn-danger" id="setInvalidReason">–ù–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è</button>
                    </div>
                </div>
                <input type="hidden" id="reasonStudentId">
                <input type="hidden" id="reasonDateStr">
                <input type="hidden" id="reasonHourNum">
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelEditReason">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–°–¢–ê–ù–¢–´ =====
        let currentUser = null;
        let students = [];
        let attendance = {};
        let hourlyAttendance = {};
        let absenceReasons = {}; // –•—Ä–∞–Ω–∏—Ç –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–æ–≤
        let currentDate = new Date();
        let selectedDate = new Date();
        let currentWeekStart = new Date();
        const DAYS_IN_WEEK = 6;
        const HOURS_PER_DAY = 5;
        const BLACKLIST_THRESHOLD = 48; // –ü–æ—Ä–æ–≥ –¥–ª—è —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (48 —á–∞—Å–æ–≤)
        const WARNING_THRESHOLD = 36; // –ü–æ—Ä–æ–≥ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (36 —á–∞—Å–æ–≤)
        const API_BASE = '/api';
        let editMode = false;
        let savedDays = {}; // –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–Ω—è—Ö –¥–ª—è –¥–µ–∂—É—Ä–Ω–æ–≥–æ
        
        // –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π
        const professions = [
            { id: '1-260101-00-a', name: '1-260101-00 ‚Äì –ò–¥–æ—Ä–∞–∏ –¥–∞–≤–ª–∞—Ç”£ (–∞)', course: 1 },
            { id: '1-250107', name: '1-250107 ‚Äì –ò“õ—Ç–∏—Å–æ–¥–∏—ë—Ç –≤–∞ –∏–¥–æ—Ä–∞ –¥–∞—Ä –∫–æ—Ä—Ö–æ–Ω–∞', course: 1 },
            { id: '1-270101-10', name: '1-270101-10 –ò“õ—Ç–∏—Å–æ–¥–∏—ë—Ç –≤–∞ —Ç–∞—à–∫–∏–ª–∏ –∏—Å—Ç–µ“≥—Å–æ–ª–æ—Ç', course: 1 },
            { id: '1-260101-00-b', name: '1-260101-00 ‚Äì –ò–¥–æ—Ä–∞ –¥–∞–≤–ª–∞—Ç”£ (–±)', course: 1 },
            { id: '1-400103', name: '1-400103 ‚Äì –ó–µ“≥–Ω–∏ —Å—É–Ω—ä”£', course: 1 },
            { id: '1-08010107', name: '1-08010107 ‚Äì –¢–∞—ä–ª–∏–º–∏ –∫–∞—Å–±”£ (–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞)', course: 1 },
            { id: '1-40010202', name: '1-40010202 ‚Äì –¢–µ—Ö–Ω–∞–ª–æ–≥–∏—è –≤–∞ –Ω–∏–∑–æ–º–∏ –∏—Ç—Ç–∏–ª–æ–æ—Ç–∏ –¥–∞—Ä –∏“õ—Ç–∏—Å–æ–¥–∏—ë—Ç', course: 1 },
            { id: '2-260101-00', name: '2-260101-00 ‚Äì –ò–¥–æ—Ä–∞–∏ –¥–∞–≤–ª–∞—Ç”£', course: 2 },
            { id: '2-260202', name: '2-260202 ‚Äì –ú–µ–Ω–µ“∑–º–µ–Ω—Ç', course: 2 },
            { id: '2-270101-10', name: '2-270101-10 ‚Äì –ò“õ—Ç–∏—Å–æ–¥–∏—ë—Ç –≤–∞ —Ç–∞—à–∫–∏–ª–∏ –∏—Å—Ç–µ“≥—Å–æ–ª–æ—Ç (–¥–∞—Ä —Å–æ“≥–∞–∏ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞)', course: 2 },
            { id: '2-31030103', name: '2-31030103 ‚Äì –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (—Ñ–∞—ä–æ–ª–∏—è—Ç–∏ –∏“õ—Ç–∏—Å–æ–¥”£)', course: 2 },
            { id: '2-40010202', name: '2-40010202 ‚Äì –¢–µ—Ö–Ω–∞–ª–æ–≥–∏—è –≤–∞ –Ω–∏–∑–æ–º–∏ –∏—Ç—Ç–∏–ª–æ–æ—Ç –¥–∞—Ä –∏“õ—Ç–∏—Å–æ–¥–∏—ë—Ç', course: 2 },
            { id: '2-400103', name: '2-400103 ‚Äì –ó–µ“≥–Ω–∏ —Å—É–Ω—ä”£', course: 2 },
            { id: '3-260101-00', name: '3-260101-00 ‚Äì –ò–¥–æ—Ä–∞–∏ –¥–∞–≤–ª–∞—Ç”£', course: 3 },
            { id: '3-40010202', name: '3-40010202 ‚Äì –¢–µ—Ö–Ω–∞–ª–æ–≥–∏—è –≤–∞ –Ω–∏–∑–æ–º–∏ –∏—Ç—Ç–∏–ª–æ–æ—Ç–∏ –¥–∞—Ä –∏“õ—Ç–∏—Å–æ–¥–∏—ë—Ç', course: 3 },
            { id: '3-400103', name: '3-400103 ‚Äì –ó–µ“≥–Ω–∏ —Å—É–Ω—ä”£', course: 3 }
        ];

        // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        const socket = io();


        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing application...');
            loadUserData();
            setupEventListeners();
            setupSocketListeners();
            initializeApp();
        });

        function loadUserData() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                updateUIForUserRole();
            } else {
                window.location.href = 'index.html';
            }
        }

        function updateUIForUserRole() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
            
            // –î–ª—è –¥–µ–∂—É—Ä–Ω–æ–≥–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
            if (currentUser.role === 'dezhur') {
                document.getElementById('editModeContainer').style.display = 'none';
            }
        }

        function getRoleDisplayName(role) {
            const roles = {
                'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                'dekan': '–î–µ–∫–∞–Ω', 
                'dezhur': '–î–µ–∂—É—Ä–Ω—ã–π',
                'teacher': '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å'
            };
            return roles[role] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }

        function initializeApp() {
    populateProfessionSelects();
    calculateCurrentWeek();
    generateCalendar();
    updateDateDisplay();
    updateWeekDisplay();
    updateAbsenceWeekDisplay();
    loadStudents();
    loadAttendance();
    loadSavedDays();
    loadAbsenceReasons(); // ‚Üê –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ß–ö–£
}

        function populateProfessionSelects() {
            const selects = [
                'professionSelect',
                'weeklyProfessionSelect', 
                'batchProfessionSelect',
                'studentProfession',
                'absenceProfessionSelect',
                'blacklistProfessionSelect'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">–í—Å–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</option>';
                
                professions.forEach(prof => {
                    const option = document.createElement('option');
                    option.value = prof.id;
                    option.textContent = prof.name;
                    select.appendChild(option);
                });
            });
        }

        function calculateCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            currentWeekStart = new Date(today.setDate(diff));
        }

        // ===== –†–ê–ë–û–¢–ê –° API =====
        async function loadStudents() {
            try {
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤...', 'warning');
                const response = await fetch(`${API_BASE}/students`);
                if (response.ok) {
                    students = await response.json();
                    renderStudentsGrid();
                    renderWeeklyTable();
                    renderStudentsTable();
                    renderAbsenceTable();
                    updateStats();
                    updateBlacklist();
                    showNotification('–°—Ç—É–¥–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                } else {
                    throw new Error('Failed to load students');
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤', 'error');
                loadDemoStudents();
            }
        }

        async function loadAttendance() {
            try {
                const response = await fetch(`${API_BASE}/attendance`);
                if (response.ok) {
                    const data = await response.json();
                    attendance = data.daily || {};
                    hourlyAttendance = data.hourly || {};
                    renderStudentsGrid();
                    renderWeeklyTable();
                    renderAbsenceTable();
                    updateStats();
                    updateBlacklist();
                } else {
                    attendance = {};
                    hourlyAttendance = {};
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                attendance = {};
                hourlyAttendance = {};
            }
        }

        async function loadSavedDays() {
            try {
                const response = await fetch(`${API_BASE}/saved-days`);
                if (response.ok) {
                    savedDays = await response.json();
                } else {
                    savedDays = {};
                }
            } catch (error) {
                console.error('Error loading saved days:', error);
                savedDays = {};
            }
        }

        async function loadAbsenceReasons() {
            try {
                const response = await fetch(`${API_BASE}/absence-reasons`);
                if (response.ok) {
                    absenceReasons = await response.json();
                } else {
                    absenceReasons = {};
                }
            } catch (error) {
                console.error('Error loading absence reasons:', error);
                absenceReasons = {};
            }
        }

        async function saveAttendance(studentId, date, status, hour = null) {
            try {
                const attendanceData = {
                    studentId: studentId,
                    date: date,
                    status: status,
                    hour: hour
                };

                const response = await fetch(`${API_BASE}/attendance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(attendanceData)
                });

                if (response.ok) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    if (hour !== null && hour !== undefined) {
                        if (!hourlyAttendance[date]) hourlyAttendance[date] = {};
                        if (!hourlyAttendance[date][studentId]) hourlyAttendance[date][studentId] = {};
                        
                        if (status === 'unknown') {
                            delete hourlyAttendance[date][studentId][hour];
                        } else {
                            hourlyAttendance[date][studentId][hour] = status;
                        }
                    }
                    
                    socket.emit('attendance_updated', attendanceData);
                    return true;
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving attendance:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return false;
            }
        }
        async function loadAbsenceReasons() {
    try {
        const response = await fetch(`${API_BASE}/absence-reasons`);
        if (response.ok) {
            absenceReasons = await response.json();
        } else {
            absenceReasons = {};
        }
    } catch (error) {
        console.error('Error loading absence reasons:', error);
        absenceReasons = {};
    }
}

        async function saveAbsenceReason(studentId, date, hour, reason) {
            try {
                const reasonData = {
                    studentId: studentId,
                    date: date,
                    hour: hour,
                    reason: reason
                };

                const response = await fetch(`${API_BASE}/absence-reasons`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reasonData)
                });

                if (response.ok) {
                    if (!absenceReasons[date]) absenceReasons[date] = {};
                    if (!absenceReasons[date][studentId]) absenceReasons[date][studentId] = {};
                    
                    if (reason === null) {
                        delete absenceReasons[date][studentId][hour];
                    } else {
                        absenceReasons[date][studentId][hour] = reason;
                    }
                    
                    socket.emit('absence_reason_updated', reasonData);
                    return true;
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving absence reason:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return false;
            }
        }

        async function saveAllAttendanceForDay() {
            try {
                const dateStr = formatDate(selectedDate);
                const professionFilter = document.getElementById('professionSelect').value;
                
                const response = await fetch(`${API_BASE}/save-day`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        date: dateStr,
                        profession: professionFilter,
                        savedBy: currentUser.id
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    savedDays[dateStr] = savedDays[dateStr] || {};
                    savedDays[dateStr][professionFilter] = true;
                    
                    socket.emit('day_saved', { date: dateStr, profession: professionFilter });
                    showNotification('–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞', 'success');
                    renderStudentsGrid();
                    return true;
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving attendance for day:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return false;
            }
        }

        async function addStudent(studentData) {
            try {
                const response = await fetch(`${API_BASE}/students`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(studentData)
                });

                if (response.ok) {
                    const newStudent = await response.json();
                    students.push(newStudent);
                    renderStudentsGrid();
                    renderWeeklyTable();
                    renderStudentsTable();
                    renderAbsenceTable();
                    updateStats();
                    updateBlacklist();
                    
                    socket.emit('student_added', newStudent);
                    showNotification('–°—Ç—É–¥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    return true;
                } else {
                    const errorText = await response.text();
                    showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞: ' + errorText, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error adding student:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return false;
            }
        }

        async function addMultipleStudents(studentsList) {
            try {
                const response = await fetch(`${API_BASE}/students/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ students: studentsList })
                });

                if (response.ok) {
                    const result = await response.json();
                    await loadStudents();
                    showNotification(`–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${result.added} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤`, 'success');
                    return true;
                } else {
                    const errorText = await response.text();
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: ' + errorText, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error adding multiple students:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return false;
            }
        }

        async function deleteStudent(studentId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞?')) {
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/students/${studentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    students = students.filter(s => s.id !== studentId);
                    renderStudentsGrid();
                    renderWeeklyTable();
                    renderStudentsTable();
                    renderAbsenceTable();
                    updateStats();
                    updateBlacklist();
                    
                    socket.emit('student_deleted', studentId);
                    showNotification('–°—Ç—É–¥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                    return true;
                } else {
                    const errorText = await response.text();
                    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞: ' + errorText, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return false;
            }
        }

        function updateAbsenceWeekDisplay() {
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(currentWeekStart.getDate() + 5);
    
    const options = { day: 'numeric', month: 'long' };
    const startStr = currentWeekStart.toLocaleDateString('ru-RU', options);
    const endStr = weekEnd.toLocaleDateString('ru-RU', options);
    
    document.getElementById('absenceCurrentWeekRange').textContent = `${startStr} - ${endStr}`;
}

        // ===== –†–ï–ù–î–ï–†–ò–ù–ì –ò–ù–¢–ï–†–§–ï–ô–°–ê =====
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            let firstDayOfWeek = firstDay.getDay();
            if (firstDayOfWeek === 0) firstDayOfWeek = 7;
            
            for (let i = 1; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day readonly';
                calendarGrid.appendChild(emptyDay);
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('button');
                dayElement.className = 'calendar-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                const dayOfWeek = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dayElement.classList.add('weekend');
                }
                
                const today = new Date();
                if (day === today.getDate() && 
                    currentDate.getMonth() === today.getMonth() && 
                    currentDate.getFullYear() === today.getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                if (day === selectedDate.getDate() && 
                    currentDate.getMonth() === selectedDate.getMonth() && 
                    currentDate.getFullYear() === selectedDate.getFullYear()) {
                    dayElement.classList.add('selected');
                }
                
                const dateStr = formatDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), day));
                if (attendance[dateStr]) {
                    const presentCount = Object.values(attendance[dateStr]).filter(status => status === 'present').length;
                    const absentCount = Object.values(attendance[dateStr]).filter(status => status === 'absent').length;
                    
                    if (presentCount > 0 || absentCount > 0) {
                        const stats = document.createElement('div');
                        stats.className = 'day-stats';
                        stats.textContent = `${presentCount}‚úì ${absentCount}‚úó`;
                        dayElement.appendChild(stats);
                        
                        if (absentCount > 0) {
                            dayElement.classList.add('absent-data');
                        } else {
                            dayElement.classList.add('has-data');
                        }
                    }
                }
                
                dayElement.addEventListener('click', () => {
                    selectDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), day));
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            updateDateDisplay();
        }

        function renderStudentsGrid() {
            const studentsGrid = document.getElementById('studentsGrid');
            studentsGrid.innerHTML = '';
            
            if (students.length === 0) {
                studentsGrid.innerHTML = '<div class="student-card"><div class="student-name">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div></div>';
                return;
            }
            
            const dateStr = formatDate(selectedDate);
            const todayStr = formatDate(new Date());
            const isToday = dateStr === todayStr;
            
            const professionFilter = document.getElementById('professionSelect').value;
            
            const filteredStudents = students.filter(student => {
                if (professionFilter && student.group !== professionFilter) return false;
                return true;
            });
            
            if (filteredStudents.length === 0) {
                studentsGrid.innerHTML = '<div class="student-card"><div class="student-name">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º</div></div>';
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å
            const canEdit = canUserEditAttendance(dateStr, professionFilter);
            
            filteredStudents.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                
                const hourlyData = hourlyAttendance[dateStr] && hourlyAttendance[dateStr][student.id] ? 
                    hourlyAttendance[dateStr][student.id] : {};
                
                let presentHours = 0;
                let absentHours = 0;
                
                for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                    if (hourlyData[hour] === 'present') {
                        presentHours++;
                    } else if (hourlyData[hour] === 'absent') {
                        absentHours++;
                    }
                }
                
                let overallStatus = 'unknown';
                if (presentHours > 0) {
                    overallStatus = 'present';
                } else if (absentHours > 0) {
                    overallStatus = 'absent';
                }
                
                const statusText = {
                    'present': '–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª',
                    'absent': '–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª', 
                    'unknown': '–ù–µ –æ—Ç–º–µ—á–µ–Ω'
                };
                
                const statusClass = {
                    'present': 'status-present',
                    'absent': 'status-absent',
                    'unknown': 'status-unknown'
                };
                
                const professionName = professions.find(p => p.id === student.group)?.name || student.group;
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –ø—Ä–æ–ø—É—Å–∫–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
                const dailyReasons = absenceReasons[dateStr] && absenceReasons[dateStr][student.id] ? 
                    absenceReasons[dateStr][student.id] : {};
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â—É—é –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–ø—É—Å–∫–∞ (–µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–ø—É—Å–∫–∏ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ø—Ä–∏—á–∏–Ω—É)
                let overallReason = 'none';
                const reasonValues = Object.values(dailyReasons);
                if (reasonValues.length > 0) {
                    const allSameReason = reasonValues.every(val => val === reasonValues[0]);
                    if (allSameReason) {
                        overallReason = reasonValues[0];
                    }
                }
                
                const reasonText = {
                    'valid': '–£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞',
                    'invalid': '–ù–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞',
                    'none': '–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'
                };
                
                const reasonClass = {
                    'valid': 'valid',
                    'invalid': 'invalid',
                    'none': 'none'
                };
                
                studentCard.innerHTML = `
                    <div class="student-header">
                        <div>
                            <div class="student-name">${student.name}</div>
                            <div class="student-details">${professionName}</div>
                        </div>
                        <div class="attendance-status ${statusClass[overallStatus]}">
                            ${statusText[overallStatus]}
                        </div>
                    </div>
                    <div class="hourly-controls">
                        ${generateHourlyControls(student.id, hourlyData, canEdit)}
                    </div>
                    <div class="absence-reason-controls">
                        <button class="absence-reason-btn valid" 
                                data-student="${student.id}"
                                ${!canEdit || absentHours === 0 ? 'disabled' : ''}>
                            –£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è
                        </button>
                        <button class="absence-reason-btn invalid" 
                                data-student="${student.id}"
                                ${!canEdit || absentHours === 0 ? 'disabled' : ''}>
                            –ù–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è
                        </button>
                    </div>
                    <div class="absence-reason-indicator ${reasonClass[overallReason]}">
                        ${reasonText[overallReason]}
                    </div>
                    <div class="quick-actions">
                        <div class="quick-actions-title">–ë—ã—Å—Ç—Ä–∞—è –æ—Ç–º–µ—Ç–∫–∞:</div>
                        <div class="quick-actions-buttons">
                            <button class="btn-mark-all-present" 
                                    data-student="${student.id}"
                                    ${!canEdit ? 'disabled' : ''}>
                                ‚úì 5—á –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª
                            </button>
                            <button class="btn-mark-all-absent" 
                                    data-student="${student.id}"
                                    ${!canEdit ? 'disabled' : ''}>
                                ‚úó 5—á –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª
                            </button>
                        </div>
                    </div>
                    <div class="hour-summary">
                        <div class="hourly-stats">
                            <span class="hours-present">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª ${presentHours}—á</span>
                            <span class="hours-absent">–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª ${absentHours}—á</span>
                        </div>
                    </div>
                `;
                
                studentsGrid.appendChild(studentCard);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —á–∞—Å–æ–≤
            document.querySelectorAll('.hour-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    if (this.disabled) return;
                    
                    const studentId = parseInt(this.getAttribute('data-student'));
                    const hour = parseInt(this.getAttribute('data-hour'));
                    const currentStatus = this.getAttribute('data-status');
                    
                    // –¶–∏–∫–ª–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ: unknown -> present -> absent -> unknown
                    let newStatus = 'unknown';
                    if (currentStatus === 'unknown') newStatus = 'present';
                    else if (currentStatus === 'present') newStatus = 'absent';
                    
                    await saveAttendance(studentId, formatDate(selectedDate), newStatus, hour);
                    renderStudentsGrid();
                    renderWeeklyTable();
                    renderAbsenceTable();
                    updateBlacklist();
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–ø—É—Å–∫–æ–≤
            document.querySelectorAll('.absence-reason-btn.valid').forEach(button => {
                button.addEventListener('click', async function() {
                    if (this.disabled) return;
                    
                    const studentId = parseInt(this.getAttribute('data-student'));
                    const dateStr = formatDate(selectedDate);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –≤—Å–µ—Ö —á–∞—Å–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è
                    const hourlyData = hourlyAttendance[dateStr] && hourlyAttendance[dateStr][studentId] ? 
                        hourlyAttendance[dateStr][studentId] : {};
                    
                    for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                        if (hourlyData[hour] === 'absent') {
                            await saveAbsenceReason(studentId, dateStr, hour, 'valid');
                        }
                    }
                    
                    renderStudentsGrid();
                    renderAbsenceTable();
                    showNotification('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–ø—É—Å–∫–æ–≤', 'success');
                });
            });

            document.querySelectorAll('.absence-reason-btn.invalid').forEach(button => {
                button.addEventListener('click', async function() {
                    if (this.disabled) return;
                    
                    const studentId = parseInt(this.getAttribute('data-student'));
                    const dateStr = formatDate(selectedDate);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –≤—Å–µ—Ö —á–∞—Å–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è
                    const hourlyData = hourlyAttendance[dateStr] && hourlyAttendance[dateStr][studentId] ? 
                        hourlyAttendance[dateStr][studentId] : {};
                    
                    for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                        if (hourlyData[hour] === 'absent') {
                            await saveAbsenceReason(studentId, dateStr, hour, 'invalid');
                        }
                    }
                    
                    renderStudentsGrid();
                    renderAbsenceTable();
                    showNotification('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–ø—É—Å–∫–æ–≤', 'success');
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±—ã—Å—Ç—Ä–æ–π –æ—Ç–º–µ—Ç–∫–∏
            document.querySelectorAll('.btn-mark-all-present').forEach(button => {
                button.addEventListener('click', async function() {
                    if (this.disabled) return;
                    
                    const studentId = parseInt(this.getAttribute('data-student'));
                    const dateStr = formatDate(selectedDate);
                    
                    // –û—Ç–º–µ—á–∞–µ–º –≤—Å–µ 5 —á–∞—Å–æ–≤ –∫–∞–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ
                    for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                        await saveAttendance(studentId, dateStr, 'present', hour);
                    }
                    
                    renderStudentsGrid();
                    renderWeeklyTable();
                    renderAbsenceTable();
                    updateBlacklist();
                    showNotification('–û—Ç–º–µ—á–µ–Ω–æ 5 —á–∞—Å–æ–≤ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è', 'success');
                });
            });

            document.querySelectorAll('.btn-mark-all-absent').forEach(button => {
                button.addEventListener('click', async function() {
                    if (this.disabled) return;
                    
                    const studentId = parseInt(this.getAttribute('data-student'));
                    const dateStr = formatDate(selectedDate);
                    
                    // –û—Ç–º–µ—á–∞–µ–º –≤—Å–µ 5 —á–∞—Å–æ–≤ –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ
                    for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                        await saveAttendance(studentId, dateStr, 'absent', hour);
                    }
                    
                    renderStudentsGrid();
                    renderWeeklyTable();
                    renderAbsenceTable();
                    updateBlacklist();
                    showNotification('–û—Ç–º–µ—á–µ–Ω–æ 5 —á–∞—Å–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è', 'success');
                });
            });
            
            updateDailyStats();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            updateSaveButtonVisibility(dateStr, professionFilter);
        }

        function canUserEditAttendance(dateStr, professionFilter) {
            const todayStr = formatDate(new Date());
            const isToday = dateStr === todayStr;
            
            // –ê–¥–º–∏–Ω –∏ –¥–µ–∫–∞–Ω –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—É—é –¥–∞—Ç—É
            if (currentUser.role === 'admin' || currentUser.role === 'dekan') {
                return editMode;
            }
            
            // –î–µ–∂—É—Ä–Ω—ã–π –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
            if (currentUser.role === 'dezhur') {
                if (!isToday) return false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –¥–µ–Ω—å –¥–ª—è —ç—Ç–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
                const isSaved = savedDays[dateStr] && savedDays[dateStr][professionFilter];
                return !isSaved;
            }
            
            return false;
        }

        function updateSaveButtonVisibility(dateStr, professionFilter) {
            const saveSection = document.getElementById('saveSection');
            const todayStr = formatDate(new Date());
            const isToday = dateStr === todayStr;
            
            if (currentUser.role === 'dezhur') {
                if (isToday && professionFilter && !(savedDays[dateStr] && savedDays[dateStr][professionFilter])) {
                    saveSection.style.display = 'block';
                    document.getElementById('saveAttendanceBtn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å';
                    document.getElementById('saveAttendanceBtn').className = 'btn btn-success';
                } else {
                    saveSection.style.display = 'none';
                }
            } else if (currentUser.role === 'admin' || currentUser.role === 'dekan') {
                saveSection.style.display = 'block';
                document.getElementById('saveAttendanceBtn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å';
                document.getElementById('saveAttendanceBtn').className = 'btn btn-primary';
            } else {
                saveSection.style.display = 'none';
            }
        }

        function generateHourlyControls(studentId, hourlyData, canEdit) {
            let controlsHTML = '';
            
            for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                const currentStatus = hourlyData[hour] || 'unknown';
                let buttonClass = 'hour-btn';
                let buttonText = hour;
                
                if (currentStatus === 'present') {
                    buttonClass += ' present';
                    buttonText = '‚úì';
                } else if (currentStatus === 'absent') {
                    buttonClass += ' absent';
                    buttonText = '‚úó';
                }
                
                controlsHTML += `
                    <div>
                        <div class="hour-label">${hour}—á</div>
                        <button class="${buttonClass}" 
                                data-student="${studentId}" 
                                data-hour="${hour}"
                                data-status="${currentStatus}"
                                ${!canEdit ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            }
            
            return controlsHTML;
        }

        function renderWeeklyTable() {
            const weeklyTableHead = document.getElementById('weeklyTableHead');
            const weeklyTableBody = document.getElementById('weeklyTableBody');
            weeklyTableHead.innerHTML = '';
            weeklyTableBody.innerHTML = '';
            
            if (students.length === 0) {
                weeklyTableBody.innerHTML = '<tr><td colspan="' + (DAYS_IN_WEEK * HOURS_PER_DAY + 2) + '">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
                return;
            }
            
            const professionFilter = document.getElementById('weeklyProfessionSelect').value;
            
            const filteredStudents = students.filter(student => {
                if (professionFilter && student.group !== professionFilter) return false;
                return true;
            });
            
            if (filteredStudents.length === 0) {
                weeklyTableBody.innerHTML = '<tr><td colspan="' + (DAYS_IN_WEEK * HOURS_PER_DAY + 2) + '">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º</td></tr>';
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            let headerHTML = '<tr><th class="student-name-cell" rowspan="2">–°—Ç—É–¥–µ–Ω—Ç</th>';
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
            for (let i = 0; i < DAYS_IN_WEEK; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Å –ø–æ–ª–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –¥–Ω—è –Ω–µ–¥–µ–ª–∏
                const dayName = date.toLocaleDateString('ru-RU', { weekday: 'long' });
                const dateNumber = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å day-separator –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è –≤ –Ω–µ–¥–µ–ª–µ
                const isLastDay = i === DAYS_IN_WEEK - 1;
                headerHTML += `<th colspan="${HOURS_PER_DAY}" ${isLastDay ? '' : 'class="day-separator"'} style="text-align: center;">
                    <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${dayName}</div>
                    <div style="font-size: 12px; opacity: 0.8;">${dateNumber}</div>
                </th>`;
            }

            headerHTML += '<th rowspan="2">–í—Å–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤</th></tr>';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —á–∞—Å–æ–≤
            headerHTML += '<tr>';
            for (let i = 0; i < DAYS_IN_WEEK; i++) {
                for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å last-hour-of-day –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞—Å–∞ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
                    const isLastHour = hour === HOURS_PER_DAY;
                    const isLastDay = i === DAYS_IN_WEEK - 1;
                    headerHTML += `<th ${isLastHour && !isLastDay ? 'class="last-hour-of-day"' : ''}>${hour}—á</th>`;
                }
            }
            headerHTML += '</tr>';
            
            weeklyTableHead.innerHTML = headerHTML;
            
            // –î–∞–Ω–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            filteredStudents.forEach(student => {
                const row = document.createElement('tr');
                
                // –ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞
                const nameCell = document.createElement('td');
                nameCell.className = 'student-name-cell';
                nameCell.textContent = student.name;
                row.appendChild(nameCell);
                
                let totalAbsentHours = 0;
                
                // –î–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º –∏ —á–∞—Å–∞–º
                for (let i = 0; i < DAYS_IN_WEEK; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(currentWeekStart.getDate() + i);
                    const dateStr = formatDate(date);
                    
                    const dailyHourlyData = hourlyAttendance[dateStr] && hourlyAttendance[dateStr][student.id] ? 
                        hourlyAttendance[dateStr][student.id] : {};
                    
                    for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                        const cell = document.createElement('td');
                        const status = dailyHourlyData[hour];
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å last-hour-of-day –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞—Å–∞ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è)
                        const isLastHour = hour === HOURS_PER_DAY;
                        const isLastDay = i === DAYS_IN_WEEK - 1;
                        if (isLastHour && !isLastDay) {
                            cell.classList.add('last-hour-of-day');
                        }
                        
                        if (status === 'present') {
                            cell.className += ' present-cell';
                            cell.textContent = '‚úì';
                        } else if (status === 'absent') {
                            cell.className += ' absent-cell';
                            cell.textContent = '‚úó';
                            totalAbsentHours++;
                        } else {
                            cell.textContent = '';
                        }
                        
                        row.appendChild(cell);
                    }
                }
                
                // –ò—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤
                const totalCell = document.createElement('td');
                totalCell.className = 'total-cell';
                totalCell.textContent = totalAbsentHours;
                row.appendChild(totalCell);
                
                weeklyTableBody.appendChild(row);
            });
            
            updateWeeklyStats();
        }

        function renderAbsenceTable() {
            const absenceTableHead = document.getElementById('absenceTableHead');
            const absenceTableBody = document.getElementById('absenceTableBody');
            absenceTableHead.innerHTML = '';
            absenceTableBody.innerHTML = '';
            
            if (students.length === 0) {
                absenceTableBody.innerHTML = '<tr><td colspan="' + (DAYS_IN_WEEK * HOURS_PER_DAY + 3) + '">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
                return;
            }
            
            const professionFilter = document.getElementById('absenceProfessionSelect').value;
            
            const filteredStudents = students.filter(student => {
                if (professionFilter && student.group !== professionFilter) return false;
                return true;
            });
            
            if (filteredStudents.length === 0) {
                absenceTableBody.innerHTML = '<tr><td colspan="' + (DAYS_IN_WEEK * HOURS_PER_DAY + 3) + '">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º</td></tr>';
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            let headerHTML = '<tr><th class="student-name-cell" rowspan="2">–°—Ç—É–¥–µ–Ω—Ç</th>';
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
            for (let i = 0; i < DAYS_IN_WEEK; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                
                const dayName = date.toLocaleDateString('ru-RU', { weekday: 'long' });
                const dateNumber = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                
                const isLastDay = i === DAYS_IN_WEEK - 1;
                headerHTML += `<th colspan="${HOURS_PER_DAY}" ${isLastDay ? '' : 'class="day-separator"'} style="text-align: center;">
                    <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${dayName}</div>
                    <div style="font-size: 12px; opacity: 0.8;">${dateNumber}</div>
                </th>`;
            }

            headerHTML += '<th rowspan="2">–í—Å–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤</th></tr>';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —á–∞—Å–æ–≤
            headerHTML += '<tr>';
            for (let i = 0; i < DAYS_IN_WEEK; i++) {
                for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                    const isLastHour = hour === HOURS_PER_DAY;
                    const isLastDay = i === DAYS_IN_WEEK - 1;
                    headerHTML += `<th ${isLastHour && !isLastDay ? 'class="last-hour-of-day"' : ''}>${hour}—á</th>`;
                }
            }
            headerHTML += '</tr>';
            
            absenceTableHead.innerHTML = headerHTML;
            
            // –î–∞–Ω–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            filteredStudents.forEach(student => {
                const row = document.createElement('tr');
                
                // –ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞
                const nameCell = document.createElement('td');
                nameCell.className = 'student-name-cell';
                nameCell.textContent = student.name;
                row.appendChild(nameCell);
                
                let totalAbsentHours = 0;
                
                // –î–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º –∏ —á–∞—Å–∞–º
                for (let i = 0; i < DAYS_IN_WEEK; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(currentWeekStart.getDate() + i);
                    const dateStr = formatDate(date);
                    
                    const dailyHourlyData = hourlyAttendance[dateStr] && hourlyAttendance[dateStr][student.id] ? 
                        hourlyAttendance[dateStr][student.id] : {};
                    
                    const dailyReasons = absenceReasons[dateStr] && absenceReasons[dateStr][student.id] ? 
                        absenceReasons[dateStr][student.id] : {};
                    
                    for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                        const cell = document.createElement('td');
                        const status = dailyHourlyData[hour];
                        const reason = dailyReasons[hour];
                        
                        const isLastHour = hour === HOURS_PER_DAY;
                        const isLastDay = i === DAYS_IN_WEEK - 1;
                        if (isLastHour && !isLastDay) {
                            cell.classList.add('last-hour-of-day');
                        }
                        
                        if (status === 'absent') {
                            totalAbsentHours++;
                            
                            if (reason === 'valid') {
                                cell.className = 'reason-cell reason-valid';
                                cell.textContent = '–£';
                                cell.title = '–£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞';
                            } else if (reason === 'invalid') {
                                cell.className = 'reason-cell reason-invalid';
                                cell.textContent = '–ù';
                                cell.title = '–ù–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞';
                            } else {
                                cell.className = 'reason-cell';
                                cell.textContent = '?';
                                cell.title = '–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                            }
                            
                            // –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã
                            if (currentUser.role === 'admin') {
                                cell.style.cursor = 'pointer';
                                cell.addEventListener('click', () => {
                                    showEditReasonModal(student, date, hour, reason);
                                });
                            }
                        } else if (status === 'present') {
                            cell.className = 'present-cell';
                            cell.textContent = '‚úì';
                        } else {
                            cell.textContent = '';
                        }
                        
                        row.appendChild(cell);
                    }
                }
                
                // –ò—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤
                const totalCell = document.createElement('td');
                totalCell.className = 'total-cell';
                totalCell.textContent = totalAbsentHours;
                row.appendChild(totalCell);
                
                absenceTableBody.appendChild(row);
            });
        }

        function renderStudentsTable() {
            const studentsTableBody = document.getElementById('studentsTableBody');
            studentsTableBody.innerHTML = '';
            
            if (students.length === 0) {
                studentsTableBody.innerHTML = '<div class="student-card"><div class="student-name">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div></div>';
                return;
            }
            
            students.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                
                const professionName = professions.find(p => p.id === student.group)?.name || student.group;
                
                studentCard.innerHTML = `
                    <div class="student-header">
                        <div>
                            <div class="student-name">${student.name}</div>
                            <div class="student-details">${professionName}</div>
                        </div>
                    </div>
                    <div class="card-attendance-controls">
                        ${currentUser.role === 'admin' || currentUser.role === 'dekan' ? 
                            `<button class="btn btn-danger" onclick="deleteStudent(${student.id})">–£–¥–∞–ª–∏—Ç—å</button>` : 
                            `<button class="btn" disabled>–£–¥–∞–ª–∏—Ç—å</button>`
                        }
                    </div>
                `;
                
                studentsTableBody.appendChild(studentCard);
            });
        }

        function updateBlacklist() {
            const blacklistStudents = document.getElementById('blacklistStudents');
            blacklistStudents.innerHTML = '';
            
            const professionFilter = document.getElementById('blacklistProfessionSelect').value;
            
            const filteredStudents = students.filter(student => {
                if (professionFilter && student.group !== professionFilter) return false;
                return true;
            });
            
            let blacklistCount = 0;
            let warningCount = 0;
            let totalAbsenceHours = 0;
            const blacklistedStudents = [];
            const warnedStudents = [];
            
            // –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–ø—É—Å–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            filteredStudents.forEach(student => {
                let studentAbsenceHours = 0;
                
                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –¥–Ω—è–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
                for (let i = 0; i < 30; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = formatDate(date);
                    
                    const dailyHourlyData = hourlyAttendance[dateStr] && hourlyAttendance[dateStr][student.id] ? 
                        hourlyAttendance[dateStr][student.id] : {};
                    
                    // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ–ø—É—Å–∫–∏ (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è)
                    for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                        if (dailyHourlyData[hour] === 'absent') {
                            studentAbsenceHours++;
                        }
                    }
                }
                
                totalAbsenceHours += studentAbsenceHours;
                
                if (studentAbsenceHours >= BLACKLIST_THRESHOLD) {
                    blacklistCount++;
                    blacklistedStudents.push({
                        student: student,
                        absenceHours: studentAbsenceHours
                    });
                } else if (studentAbsenceHours >= WARNING_THRESHOLD) {
                    warningCount++;
                    warnedStudents.push({
                        student: student,
                        absenceHours: studentAbsenceHours
                    });
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('blacklistCount').textContent = blacklistCount;
            document.getElementById('warningCount').textContent = warningCount;
            document.getElementById('totalAbsenceHours').textContent = totalAbsenceHours;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ
            if (blacklistedStudents.length === 0 && warnedStudents.length === 0) {
                blacklistStudents.innerHTML = '<div class="blacklist-student info">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–∞ –≥—Ä–∞–Ω–∏ –ø–æ–ø–∞–¥–∞–Ω–∏—è</div>';
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø—Ä–æ–ø—É—Å–∫–æ–≤ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
            blacklistedStudents.sort((a, b) => b.absenceHours - a.absenceHours);
            warnedStudents.sort((a, b) => b.absenceHours - a.absenceHours);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ
            blacklistedStudents.forEach(item => {
                const studentElement = document.createElement('div');
                studentElement.className = 'blacklist-student';
                studentElement.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div>
                            <strong>${item.student.name}</strong>
                            <div style="font-size: 12px; color: var(--gray); margin-top: 4px;">
                                ${professions.find(p => p.id === item.student.group)?.name || item.student.group}
                            </div>
                        </div>
                        <div style="font-size: 18px; font-weight: bold; color: var(--danger);">
                            ${item.absenceHours}—á
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: var(--danger);">
                        ‚ö†Ô∏è –°—Ç—É–¥–µ–Ω—Ç –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ (–ø—Ä–µ–≤—ã—à–µ–Ω –ø–æ—Ä–æ–≥ ${BLACKLIST_THRESHOLD} —á–∞—Å–æ–≤ –ø—Ä–æ–ø—É—Å–∫–æ–≤)
                    </div>
                `;
                blacklistStudents.appendChild(studentElement);
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –Ω–∞ –≥—Ä–∞–Ω–∏ –ø–æ–ø–∞–¥–∞–Ω–∏—è
            warnedStudents.forEach(item => {
                const studentElement = document.createElement('div');
                studentElement.className = 'blacklist-student warning';
                studentElement.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div>
                            <strong>${item.student.name}</strong>
                            <div style="font-size: 12px; color: var(--gray); margin-top: 4px;">
                                ${professions.find(p => p.id === item.student.group)?.name || item.student.group}
                            </div>
                        </div>
                        <div style="font-size: 18px; font-weight: bold; color: var(--warning);">
                            ${item.absenceHours}—á
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: var(--warning);">
                        ‚ö†Ô∏è –°—Ç—É–¥–µ–Ω—Ç –Ω–∞ –≥—Ä–∞–Ω–∏ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
                    </div>
                `;
                blacklistStudents.appendChild(studentElement);
            });
        }

        function showEditReasonModal(student, date, hour, currentReason) {
            if (currentUser.role !== 'admin') {
                showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–æ–≤', 'error');
                return;
            }
            
            document.getElementById('reasonStudentName').value = student.name;
            document.getElementById('reasonDate').value = date.toLocaleDateString('ru-RU');
            document.getElementById('reasonHour').value = `${hour} —á–∞—Å`;
            document.getElementById('reasonStudentId').value = student.id;
            document.getElementById('reasonDateStr').value = formatDate(date);
            document.getElementById('reasonHourNum').value = hour;
            
            document.getElementById('editReasonModal').classList.add('show');
        }

        function hideEditReasonModal() {
            document.getElementById('editReasonModal').classList.remove('show');
        }

        // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
        function setupEventListeners() {
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
            document.getElementById('prevMonth').addEventListener('click', () => navigateMonths(-1));
            document.getElementById('nextMonth').addEventListener('click', () => navigateMonths(1));
            document.getElementById('todayBtn').addEventListener('click', goToToday);
            
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º
            document.getElementById('prevWeek').addEventListener('click', () => navigateWeeks(-1));
            document.getElementById('nextWeek').addEventListener('click', () => navigateWeeks(1));

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤
    document.getElementById('absencePrevWeek').addEventListener('click', () => navigateAbsenceWeeks(-1));
    document.getElementById('absenceNextWeek').addEventListener('click', () => navigateAbsenceWeeks(1));
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    switchPage(page);
                });
            });
            
            // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ –∏ –¥–µ–∫–∞–Ω–∞)
            document.getElementById('editModeBtn').addEventListener('click', toggleEditMode);
            
            // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞
            document.getElementById('addStudentBtn').addEventListener('click', showAddStudentModal);
            document.getElementById('confirmAddStudent').addEventListener('click', addNewStudent);
            document.getElementById('cancelAddStudent').addEventListener('click', hideAddStudentModal);
            document.getElementById('closeAddStudentModal').addEventListener('click', hideAddStudentModal);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            document.getElementById('addMultipleStudentsBtn').addEventListener('click', showAddMultipleStudentsModal);
            document.getElementById('confirmMultipleStudents').addEventListener('click', addMultipleStudents);
            document.getElementById('cancelMultipleStudents').addEventListener('click', hideAddMultipleStudentsModal);
            document.getElementById('closeMultipleStudentsModal').addEventListener('click', hideAddMultipleStudentsModal);
            
            // –§–∏–ª—å—Ç—Ä—ã
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilters);
            document.getElementById('weeklyApplyFilterBtn').addEventListener('click', applyWeeklyFilters);
            document.getElementById('absenceApplyFilterBtn').addEventListener('click', applyAbsenceFilters);
            document.getElementById('blacklistApplyFilterBtn').addEventListener('click', applyBlacklistFilters);
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
            document.getElementById('saveAttendanceBtn').addEventListener('click', saveAllAttendance);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            document.getElementById('multipleStudentsNames').addEventListener('input', updateMultipleStudentsPreview);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–ø—É—Å–∫–æ–≤
            document.getElementById('setValidReason').addEventListener('click', () => setAbsenceReason('valid'));
            document.getElementById('setInvalidReason').addEventListener('click', () => setAbsenceReason('invalid'));
            document.getElementById('cancelEditReason').addEventListener('click', hideEditReasonModal);
            document.getElementById('closeEditReasonModal').addEventListener('click', hideEditReasonModal);
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
                console.log('Connected to server via WebSocket');
                document.getElementById('statusIndicator').className = 'status-indicator';
                document.getElementById('statusText').textContent = '–û–Ω–ª–∞–π–Ω';
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                document.getElementById('statusIndicator').className = 'status-indicator offline';
                document.getElementById('statusText').textContent = '–û—Ñ–ª–∞–π–Ω';
            });
            
            socket.on('attendance_updated', (data) => {
                console.log('Attendance updated via WebSocket:', data);
                
                if (data.hour !== null && data.hour !== undefined) {
                    if (!hourlyAttendance[data.date]) {
                        hourlyAttendance[data.date] = {};
                    }
                    if (!hourlyAttendance[data.date][data.studentId]) {
                        hourlyAttendance[data.date][data.studentId] = {};
                    }
                    
                    if (data.status === 'unknown') {
                        delete hourlyAttendance[data.date][data.studentId][data.hour];
                    } else {
                        hourlyAttendance[data.date][data.studentId][data.hour] = data.status;
                    }
                }
                
                if (formatDate(selectedDate) === data.date) {
                    renderStudentsGrid();
                }
                
                if (isDateInCurrentWeek(new Date(data.date))) {
                    renderWeeklyTable();
                    renderAbsenceTable();
                }
                
                updateBlacklist();
            });
            
            socket.on('student_added', (student) => {
                console.log('Student added via WebSocket:', student);
                
                if (!students.find(s => s.id === student.id)) {
                    students.push(student);
                    renderStudentsGrid();
                    renderWeeklyTable();
                    renderStudentsTable();
                    renderAbsenceTable();
                    updateStats();
                    updateBlacklist();
                }
            });
            
            socket.on('student_deleted', (studentId) => {
                console.log('Student deleted via WebSocket:', studentId);
                
                students = students.filter(s => s.id !== studentId);
                renderStudentsGrid();
                renderWeeklyTable();
                renderStudentsTable();
                renderAbsenceTable();
                updateStats();
                updateBlacklist();
            });
            
            socket.on('day_saved', (data) => {
                console.log('Day saved via WebSocket:', data);
                
                savedDays[data.date] = savedDays[data.date] || {};
                savedDays[data.date][data.profession] = true;
                
                if (formatDate(selectedDate) === data.date) {
                    renderStudentsGrid();
                }
            });
            
            socket.on('absence_reason_updated', (data) => {
                console.log('Absence reason updated via WebSocket:', data);
                
                if (!absenceReasons[data.date]) absenceReasons[data.date] = {};
                if (!absenceReasons[data.date][data.studentId]) absenceReasons[data.date][data.studentId] = {};
                
                if (data.reason === null) {
                    delete absenceReasons[data.date][data.studentId][data.hour];
                } else {
                    absenceReasons[data.date][data.studentId][data.hour] = data.reason;
                }
                
                if (isDateInCurrentWeek(new Date(data.date))) {
                    renderAbsenceTable();
                }
            });
        }

        // ===== –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
        function navigateMonths(months) {
            currentDate.setMonth(currentDate.getMonth() + months);
            generateCalendar();
        }

        function goToToday() {
            selectedDate = new Date();
            currentDate = new Date();
            updateDateDisplay();
            generateCalendar();
            renderStudentsGrid();
        }

        function navigateWeeks(weeks) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (weeks * 7));
            updateWeekDisplay();
            renderWeeklyTable();
            renderAbsenceTable();
        }

        function navigateAbsenceWeeks(weeks) {
    currentWeekStart.setDate(currentWeekStart.getDate() + (weeks * 7));
    updateWeekDisplay();
    updateAbsenceWeekDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤
    renderWeeklyTable();
    renderAbsenceTable(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ–ø—É—Å–∫–æ–≤
}

        function switchPage(page) {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(page + 'Page').classList.add('active');
    document.querySelector(`.tab[data-page="${page}"]`).classList.add('active');
    
    if (page === 'blacklist') {
        updateBlacklist();
    } else if (page === 'absence') {
        updateAbsenceWeekDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
    }
}

        function selectDate(date) {
            selectedDate = date;
            updateDateDisplay();
            renderStudentsGrid();
            generateCalendar();
        }

        function toggleEditMode() {
            // –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ –∏ –¥–µ–∫–∞–Ω–∞
            if (currentUser.role !== 'admin' && currentUser.role !== 'dekan') {
                return;
            }
            
            editMode = !editMode;
            const editBtn = document.getElementById('editModeBtn');
            const indicator = document.getElementById('editModeIndicator');
            
            if (editMode) {
                editBtn.textContent = '‚úÖ –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                editBtn.classList.remove('btn-warning');
                editBtn.classList.add('btn-success');
                indicator.style.display = 'inline-flex';
                showNotification('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω', 'success');
            } else {
                editBtn.textContent = '‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                editBtn.classList.remove('btn-success');
                editBtn.classList.add('btn-warning');
                indicator.style.display = 'none';
                showNotification('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
            }
            
            renderStudentsGrid();
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function applyFilters() {
            renderStudentsGrid();
        }

        function applyWeeklyFilters() {
            renderWeeklyTable();
        }

        function applyAbsenceFilters() {
            renderAbsenceTable();
        }

        function applyBlacklistFilters() {
            updateBlacklist();
        }

        async function saveAllAttendance() {
            if (currentUser.role === 'dezhur') {
                // –î–ª—è –¥–µ–∂—É—Ä–Ω–æ–≥–æ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –±–ª–æ–∫–∏—Ä—É–µ–º
                await saveAllAttendanceForDay();
            } else {
                // –î–ª—è –∞–¥–º–∏–Ω–∞ –∏ –¥–µ–∫–∞–Ω–∞ - –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                showNotification('–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...', 'warning');
                // –î–∞–Ω–Ω—ã–µ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–ª–∏–∫–µ —á–µ—Ä–µ–∑ saveAttendance
                setTimeout(() => {
                    showNotification('–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
                }, 500);
            }
        }

        function showAddStudentModal() {
            document.getElementById('addStudentModal').classList.add('show');
        }

        function hideAddStudentModal() {
            document.getElementById('addStudentModal').classList.remove('show');
            document.getElementById('studentName').value = '';
            document.getElementById('studentProfession').value = '';
        }

        function showAddMultipleStudentsModal() {
            const professionSelect = document.getElementById('batchProfessionSelect');
            const selectedProfession = professionSelect.value;
            
            if (!selectedProfession) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é', 'error');
                return;
            }
            
            const professionName = professions.find(p => p.id === selectedProfession)?.name || selectedProfession;
            
            document.getElementById('selectedProfessionName').textContent = professionName;
            document.getElementById('multipleStudentsProfession').value = selectedProfession;
            document.getElementById('multipleStudentsNames').value = '';
            
            updateMultipleStudentsPreview();
            
            document.getElementById('addMultipleStudentsModal').classList.add('show');
        }

        function hideAddMultipleStudentsModal() {
            document.getElementById('addMultipleStudentsModal').classList.remove('show');
        }

        function updateMultipleStudentsPreview() {
            const namesText = document.getElementById('multipleStudentsNames').value;
            const names = namesText.split('\n').filter(name => name.trim() !== '');
            const preview = document.getElementById('multipleStudentsPreview');
            
            preview.innerHTML = '';
            
            if (names.length === 0) {
                preview.innerHTML = '<div class="student-preview-item">–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div>';
                return;
            }
            
            if (names.length > 33) {
                preview.innerHTML = '<div class="student-preview-item" style="color: var(--danger);">–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤ 33 —Å—Ç—É–¥–µ–Ω—Ç–∞</div>';
                return;
            }
            
            names.forEach((name, index) => {
                const item = document.createElement('div');
                item.className = 'student-preview-item';
                item.textContent = `${index + 1}. ${name.trim()}`;
                preview.appendChild(item);
            });
        }

        async function addNewStudent() {
            const name = document.getElementById('studentName').value.trim();
            const profession = document.getElementById('studentProfession').value;
            
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞', 'error');
                return;
            }
            
            if (!profession) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é —Å—Ç—É–¥–µ–Ω—Ç–∞', 'error');
                return;
            }
            
            const professionData = professions.find(p => p.id === profession);
            
            const studentData = {
                name: name,
                group: profession,
                course: professionData.course
            };
            
            const success = await addStudent(studentData);
            if (success) {
                hideAddStudentModal();
            }
        }

        async function addMultipleStudents() {
            const namesText = document.getElementById('multipleStudentsNames').value;
            const profession = document.getElementById('multipleStudentsProfession').value;
            
            if (!namesText.trim()) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤', 'error');
                return;
            }
            
            const names = namesText.split('\n')
                .filter(name => name.trim() !== '')
                .slice(0, 33);
            
            if (names.length === 0) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤', 'error');
                return;
            }
            
            const professionData = professions.find(p => p.id === profession);
            if (!professionData) {
                showNotification('–û—à–∏–±–∫–∞: –ø—Ä–æ—Ñ–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                return;
            }
            
            const studentsList = names.map(name => ({
                name: name.trim(),
                group: profession,
                course: professionData.course
            }));
            
            console.log('Attempting to add students:', studentsList);
            
            const success = await addMultipleStudents(studentsList);
            if (success) {
                hideAddMultipleStudentsModal();
            }
        }

        async function setAbsenceReason(reason) {
            const studentId = parseInt(document.getElementById('reasonStudentId').value);
            const dateStr = document.getElementById('reasonDateStr').value;
            const hour = parseInt(document.getElementById('reasonHourNum').value);
            
            const success = await saveAbsenceReason(studentId, dateStr, hour, reason);
            if (success) {
                hideEditReasonModal();
                renderAbsenceTable();
                showNotification('–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            }
        }

        // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isDateInCurrentWeek(date) {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            
            return date >= currentWeekStart && date <= weekEnd;
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateDateDisplay() {
            const options = { year: 'numeric', month: 'long' };
            document.getElementById('currentDate').textContent = currentDate.toLocaleDateString('ru-RU', options);
            
            const selectedOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('selectedDateDisplay').textContent = selectedDate.toLocaleDateString('ru-RU', selectedOptions);
        }

        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 5);
            
            const options = { day: 'numeric', month: 'long' };
            const startStr = currentWeekStart.toLocaleDateString('ru-RU', options);
            const endStr = weekEnd.toLocaleDateString('ru-RU', options);
            
            document.getElementById('currentWeekRange').textContent = `${startStr} - ${endStr}`;
        }

        function updateDailyStats() {
            const dateStr = formatDate(selectedDate);
            const hourlyData = hourlyAttendance[dateStr] || {};
            
            const professionFilter = document.getElementById('professionSelect').value;
            
            const filteredStudents = students.filter(student => {
                if (professionFilter && student.group !== professionFilter) return false;
                return true;
            });
            
            let totalStudents = filteredStudents.length;
            let presentCount = 0;
            let absentCount = 0;
            let totalHoursPresent = 0;
            let totalHoursAbsent = 0;
            
            filteredStudents.forEach(student => {
                const studentHourlyData = hourlyData[student.id] || {};
                let studentPresentHours = 0;
                let studentAbsentHours = 0;
                
                for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                    if (studentHourlyData[hour] === 'present') {
                        studentPresentHours++;
                    } else if (studentHourlyData[hour] === 'absent') {
                        studentAbsentHours++;
                    }
                }
                
                totalHoursPresent += studentPresentHours;
                totalHoursAbsent += studentAbsentHours;
                
                if (studentPresentHours > 0) {
                    presentCount++;
                }
                
                if (studentAbsentHours === HOURS_PER_DAY && studentPresentHours === 0) {
                    absentCount++;
                }
            });
            
            const totalPossibleHours = totalStudents * HOURS_PER_DAY;
            const attendanceRate = totalPossibleHours > 0 ? 
                Math.round((totalHoursPresent / totalPossibleHours) * 100) : 0;
            
            document.getElementById('dailyTotalStudents').textContent = totalStudents;
            document.getElementById('dailyPresent').textContent = presentCount;
            document.getElementById('dailyAbsent').textContent = absentCount;
            document.getElementById('dailyAttendance').textContent = `${attendanceRate}%`;
        }

        function updateWeeklyStats() {
            const professionFilter = document.getElementById('weeklyProfessionSelect').value;
            
            const filteredStudents = students.filter(student => {
                if (professionFilter && student.group !== professionFilter) return false;
                return true;
            });
            
            const weekDates = [];
            for (let i = 0; i < DAYS_IN_WEEK; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                weekDates.push(date);
            }
            
            let totalHoursPresent = 0;
            let totalHoursAbsent = 0;
            
            weekDates.forEach(date => {
                const dateStr = formatDate(date);
                const dailyHourlyData = hourlyAttendance[dateStr] || {};
                
                filteredStudents.forEach(student => {
                    const studentHourlyData = dailyHourlyData[student.id] || {};
                    
                    for (let hour = 1; hour <= HOURS_PER_DAY; hour++) {
                        if (studentHourlyData[hour] === 'present') {
                            totalHoursPresent++;
                        } else if (studentHourlyData[hour] === 'absent') {
                            totalHoursAbsent++;
                        }
                    }
                });
            });
            
            const totalTrackedHours = totalHoursPresent + totalHoursAbsent;
            const avgAttendance = totalTrackedHours > 0 ? 
                Math.round((totalHoursPresent / totalTrackedHours) * 100) : 0;
            
            document.getElementById('weeklyTotalStudents').textContent = filteredStudents.length;
            document.getElementById('weeklyAvgAttendance').textContent = `${avgAttendance}%`;
            document.getElementById('weeklyTotalPresent').textContent = totalHoursPresent;
            document.getElementById('weeklyTotalAbsent').textContent = totalHoursAbsent;
        }

        function updateStats() {
            updateDailyStats();
            updateWeeklyStats();
        }

        // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function loadDemoStudents() {
            console.log('Loading demo students data...');
            students = [
                { id: 1, name: '–ê–ª–∏—à–µ—Ä –£—Å–º–∞–Ω–æ–≤', group: '1-260101-00-a', course: 1 },
                { id: 2, name: '–§–∞—Ä—Ö–æ–¥ –†–∞—Ö–∏–º–æ–≤', group: '1-260101-00-a', course: 1 },
                { id: 3, name: '–®–∞—Ö–∑–æ–¥ –£—Å—É–ø–æ–≤', group: '1-260101-00-a', course: 1 },
                { id: 4, name: '–ì–∞–ª–∏–Ω–∞ –¢–æ–ª–æ—á–∫–æ', group: '1-250107', course: 1 },
                { id: 5, name: '–ú–∏—Ä–æ—Å–ª–∞–≤ –£–ª—å—è–Ω–µ–Ω–∫–æ', group: '1-250107', course: 1 }
            ];
            renderStudentsGrid();
            renderWeeklyTable();
            renderStudentsTable();
            renderAbsenceTable();
            updateStats();
            updateBlacklist();
        }
    </script>
</body>
</html>
